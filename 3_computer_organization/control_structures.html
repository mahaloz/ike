<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Control Structures - &#x27;Ike</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">&#x27;Ike</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="control-structures"><a class="header" href="#control-structures">Control Structures</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>Control structures are patterns of assembly code that create some kind of more abstract flow controlling thing. As an example, the <code>if</code> statement we used earlier is a control structure. Control structures are used to make our code do interesting and complex things like make decisions in a loop, conditional do stuff, and easily make code reusable and understandable.</p>
<p>The first up of these control structures is one that makes code easy to reuse: functions!</p>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<p>A function is a piece of code that you can reuse more than once that can take some arguments and return some values. It's essentially just like a normal math function. Take for instance the classic <code>f</code> in math:</p>
<pre><code>f(x) = y
</code></pre>
<p>In this function above, it takes <code>x</code> and outputs <code>y</code>. You may not know how it translates <code>x</code> -&gt; <code>y</code>, but you know you get <code>y</code> from inputting <code>x</code>. You can make the same type of functions in x86 and most assembly languages. Earlier in <a href="./instructions.html#call-instructions">call-instructions</a>, we actually provided you with a function. Here it is again:</p>
<pre><code class="language-c">// args in rdi, output in rax
make_even:
mov rdx, rdi
mov rax, 2 
idiv 
mov rax, rdx    
cmp rax, 0 
je make_even_done
add rdi, 1
make_even_ret:
mov rax, rdi
ret
</code></pre>
<p>A very simple function to take whatever number it is given and make it even. If you are not sure how it does that, review <a href="./instructions.html">instructions</a> and how even and odd numbers work in math.</p>
<h3 id="calling-convention"><a class="header" href="#calling-convention">Calling Convention</a></h3>
<p>In this example, the first argument to the function (the input), is passed in rdi. The output is passed in rax. This passing of arguments and returns actually is called something. A <em>calling convention</em>. A calling convention is the way in which you pass arguments to a callable <em>thing</em>. The <em>thing</em> in this case is functions in x86. Just like flavors of syntax, there are <a href="https://riptutorial.com/x86/topic/3261/calling-conventions">many different calling conventions</a>. The most widely used calling convention, and the one you are most likely to see in the wild, is the <a href="https://riptutorial.com/x86/example/11197/64-bit-system-v">64-bit System V</a> calling convention.</p>
<p>In System V (<strong>the one we use here</strong>), this is how args are passed:</p>
<div class="table-wrapper"><table><thead><tr><th>Argument</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10+...</th><th>return</th></tr></thead><tbody>
<tr><td>Location</td><td>rdi</td><td>rsi</td><td>rdx</td><td>rcx</td><td>r8</td><td>r9</td><td>r10</td><td>r11</td><td>rsp</td><td>rsp+n</td><td>rax</td></tr>
<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
</tbody></table>
</div>
<p>Arguments passed 8 are all passed on the stack. Argument 9 would be <code>rsp</code>, 10 <code>rsp + 8</code>, and so forth. System V is the calling convention we will be using for the rest of the handbook and the EmbryoASM modules we will have you do at the end of this section. The return value is always one thing and its passed in rax.</p>
<p>Though we only use System V in the handbook, we felt it was worth it to mention that the 32 bit version of x86 uses <a href="https://riptutorial.com/x86/example/11196/32-bit-cdecl">cdecl</a> (commonly said as "C-deck-ul). The cdecl calling convention passes all the arguments on the stack just like System V does for arguments 9 and above.</p>
<p>Now back to our concrete examples. Say we have a function called <code>sum4</code> that returns the sum of four numbers. If we have some assembly code and we wanted to call that function with the values <code>2, 4, 8, 16</code>, this is how we would do it:</p>
<pre><code class="language-c">// some earlier code...

mov rdi, 2
mov rsi, 4
mov rdx, 8
mov rcx, 16
call sum4

// some code after...
</code></pre>
<p>Cool right? Note we can easily reuse <code>sum4</code> as many times as we like. Just as a refresher, every function ends with a <code>ret</code> so that you can reliably use <code>call</code> on it as in the example above.</p>
<h3 id="functions-and-the-stack"><a class="header" href="#functions-and-the-stack">Functions and the Stack</a></h3>
<p>It's important to know that functions often use stacks to save arguments right at the beginning of the function. This is called the <a href="https://en.wikipedia.org/wiki/Function_prologue_and_epilogue">function prolouge</a>. The reason we save things on the stack is because we might need to reuse the original argument registers:</p>
<pre><code class="language-c">// takes 3 args
my_func:
call some_other_func 
ret
</code></pre>
<p>The way to fix this is by saving things on the stack:</p>
<pre><code class="language-c">//takes 3 args
my_func:
push rdi
push rsi
push rdx
call some_other_func
pop rdx
pop rsi
pop rdi
ret
</code></pre>
<p>This is very easy to do with pops and pushes, but is often not exactly correct. In real function, you will see use of <code>rbp</code> as well. Here is a snippet of code we used in the <a href="./instructions.html">instructions</a> section:</p>
<pre><code class="language-c">000000000000112d &lt;main&gt;:
112d:       push   rbp
112e:       mov    rbp,rsp
1131:       mov    [rbp-0x8], 0x0
1138:       mov    [rbp-0x4], 0x4
113f:       mov    eax, [rbp-0x4]
1142:       add    eax, 0x5
1145:       mov    [rbp-0x8], eax
1148:       mov    eax, [rbp-0x8]
114b:       imul   eax, [rbp-0x4]
114f:       mov    [rbp-0x8], eax
</code></pre>
<p>This code is a very accurate representation of what you will see in the real world. We use the special register rbp to save the original place the stack was at the start of the function. <code>bp</code> in rbp stands for Base Pointer. It's the base pointer of the stack, or where it was before calling this function.</p>
<p>To explain the above code more:</p>
<ol>
<li>the current base pointer is saved (to be popped at the end by a leave; ret;)</li>
<li>the stack pointer becomes the base pointer</li>
<li>the base pointer is used as if it was the sp</li>
</ol>
<p>This allows us to modify the sp as we like, then when the function is done, it gets fixed up. This idea will be expanded more in the EmbryoASM challenges.</p>
<h2 id="conditionals"><a class="header" href="#conditionals">Conditionals</a></h2>
<p>Conditionals run the world. Below you will find the most common structures translated into assembly, originally shown in python like code.</p>
<h3 id="if-statements"><a class="header" href="#if-statements">if statements</a></h3>
<p>High-level:</p>
<pre><code class="language-python">if x &gt; 0:
    y = 1
else:
    y = 0
</code></pre>
<p>ASM:</p>
<pre><code class="language-c">// rdi = x; rax = y
cmp rdi, 0
jle else_label
mov rbx, 1
jmp end_label

else_label:
mov rbx, 0

end_label:
mov rax, rbx
</code></pre>
<h3 id="else-if-statements"><a class="header" href="#else-if-statements">else-if statements</a></h3>
<pre><code class="language-python">if x == 0:
    y = 1
elif x &lt; 0:
    y = -1
else
    y = 0
</code></pre>
<p>ASM:</p>
<pre><code class="language-c">// rdi = x; rax = y
cmp rdi, 0
je if_label
jl else_if_label
mov rbx, 0
jmp end_label

if_label:
mov rbx, 1
jmp end_label

else_if_label:
mov rbx, -1

end_label:
mov rax, rbx
</code></pre>
<h2 id="loops"><a class="header" href="#loops">Loops</a></h2>
<p>Loops allow you to do something many times. Like: "walk forward 18 times" actually translates to "walk forward"*18.
Here are two types of loops you can use:</p>
<h3 id="for-loop"><a class="header" href="#for-loop">For-loop</a></h3>
<p>When you know how many times you want to iterate, like the example above, you use a for-loop:
High-Level:</p>
<pre><code class="language-python">for i=0...18:
    walk_forward() 
</code></pre>
<p>ASM:</p>
<pre><code class="language-c">mov rcx, 0
loop_head:
cmp rcx, 18
jge loop_end
call walk_forward
jmp loop_head 
loop_end:
// any code after loop
mov rax, 0
</code></pre>
<h3 id="while-loop"><a class="header" href="#while-loop">while loop</a></h3>
<p>When you don't know how many times you want to iterate, or your stopping condition is something special, you use a while loop:</p>
<p>High-Level:</p>
<pre><code class="language-python">x = 80
y = 0
while x != 0:
    x = x - 2
    y += 1
</code></pre>
<p>ASM:</p>
<pre><code class="language-c">// rdi = x, rax = y
mov rdi, 80
mov rbx, 0

loop_head:
cmp rdi, 0
je loop_end
sub rdi, 2
add rbx, 1
jmp loop_head

loop_end:
mov rax, rbx
//any code after loop 
</code></pre>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>With the general knowledge of these structures, you should be ready to start making some simple programs in x86.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../3_computer_organization/asm_memory.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../3_computer_organization/hacker_practice.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../3_computer_organization/asm_memory.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../3_computer_organization/hacker_practice.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
